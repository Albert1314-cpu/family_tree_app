# 多人协作功能使用指南

## 🎯 功能概述

现在您可以实现**真正的多人协作**了！多人可以同时编辑同一个家族树，一个人添加的成员，其他人可以**实时看到**。

## ✨ 核心功能

### 1. 实时同步
- ✅ 用户 A 添加成员 → 用户 B 立即看到
- ✅ 无需手动刷新，数据自动更新
- ✅ 多人同时编辑，互不干扰

### 2. 协作模式
- ✅ 创建者启用协作模式
- ✅ 通过分享码邀请其他人加入
- ✅ 所有协作者都可以添加/编辑成员

## 📋 使用步骤

### 场景：创建一个协作家族树

#### 步骤 1: 创建家族树并上传到云端
1. 创建或选择您的家族树
2. 进入设置页面
3. 点击"登录账户"（如果未登录）
4. 点击"上传到云端"

#### 步骤 2: 启用协作模式
1. 在设置页面点击"分享家族树"
2. 系统会**自动启用协作模式**
3. 生成分享码

#### 步骤 3: 分享给其他人
1. 复制生成的分享码
2. 通过微信、短信等方式发送给其他人
3. 分享码有效期：30天

### 场景：加入其他人的协作家族树

#### 步骤 1: 获取分享码
- 从家族树创建者那里获取分享码

#### 步骤 2: 加入协作
1. 打开应用
2. 登录账户（使用自己的账号）
3. 进入设置 → "分享家族树"
4. 在"访问他人分享的家族树"中输入分享码
5. 点击"访问家族树"
6. 系统会**自动将您添加为协作者**

#### 步骤 3: 开始协作
1. 访问家族树后，您可以看到所有成员
2. 您可以添加新成员
3. 您的添加操作会**实时同步**给其他协作者

## 🔄 实时同步工作原理

### 工作流程：

```
用户A (添加成员) 
    ↓
上传到云端
    ↓
Firebase 实时数据库
    ↓
自动推送更新
    ↓
用户B (立即看到新成员)
用户C (立即看到新成员)
```

### 技术实现：
- 使用 Firebase Firestore 的**实时监听**功能
- 当有人添加成员时，所有协作者会收到通知
- 数据自动更新，无需手动刷新

## 📱 在应用中的使用

### 查看实时更新

在家族树详情页面：
- 当其他协作者添加成员时，您会看到：
  - 新成员自动出现在列表中
  - 可能有提示："有新成员添加"
  - 数据实时刷新

### 添加成员

1. 进入家族树详情页面
2. 点击右上角"+"按钮
3. 填写成员信息
4. 点击"保存"
5. **所有协作者立即能看到您添加的成员！**

## 🎨 协作标识

在协作家族树中，您可能会看到：
- ✨ "协作家族树"标识
- 👥 协作者数量显示
- ⚡ "实时同步中"状态提示

## ⚠️ 注意事项

### 1. 数据冲突处理
- 如果多人同时编辑同一成员，**最后保存的版本会生效**
- 建议：编辑前先刷新，查看最新数据

### 2. 网络要求
- 实时同步需要网络连接
- 离线时添加的数据，联网后会自动同步

### 3. 权限说明
- **创建者**：拥有完整权限（删除、修改等）
- **协作者**：可以添加/编辑成员，通常不能删除家族树

### 4. 数据安全
- 只有通过分享码加入的人才能看到数据
- 分享码过期后，新用户无法加入（已加入的不受影响）

## 💡 使用场景示例

### 场景 1: 家族聚会
1. **您**创建家族树并上传
2. 分享码给**亲戚A、亲戚B**
3. 聚会时，大家一起添加成员
4. 所有人实时看到完整的家族树

### 场景 2: 远程协作
1. **爷爷**创建家族树（他最了解家族历史）
2. 分享给**爸爸、叔叔、姑姑**
3. 大家各自添加自己了解的信息
4. 实时同步，形成完整的家族树

### 场景 3: 多代协作
1. **长辈**创建基础家族树
2. 分享给**晚辈们**
3. 长辈添加历史信息，晚辈添加新成员
4. 共同维护，实时同步

## 🔧 技术细节（可选了解）

### 数据存储结构
```
Firestore:
├── users/
│   └── {ownerId}/
│       └── family_trees/
│           └── {familyTreeId}/
│               ├── (家族树信息)
│               └── members/
│                   └── (成员列表 - 实时监听)
└── collaborative_trees/
    └── {familyTreeId}/
        └── collaborators/
            └── (协作者列表)
```

### 实时监听
应用会自动监听 `members` 集合的变化，当有新成员添加时：
1. Firebase 推送更新
2. 应用接收更新
3. UI 自动刷新
4. 显示新成员

## 🆘 常见问题

### Q1: 为什么我看不到其他人添加的成员？
**A**: 检查：
1. 网络连接是否正常
2. 是否已登录账户
3. 是否通过分享码正确加入协作

### Q2: 我的修改会覆盖别人的修改吗？
**A**: 不会覆盖不同的成员。但如果多人同时编辑**同一个成员**，最后保存的版本会生效。

### Q3: 可以撤销分享吗？
**A**: 目前分享码有效期为 30 天。已加入的协作者会继续拥有访问权限。

### Q4: 如何查看谁添加了某个成员？
**A**: 在未来版本中，可能会显示"添加者"信息。目前所有成员都会实时同步。

## 🎉 开始使用

现在就试试：
1. 创建一个家族树
2. 上传到云端
3. 生成分享码
4. 分享给朋友
5. 开始协作编辑！

**享受多人协作的便利吧！** 👥✨

